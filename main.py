import math
from DataVisualizer import DataVisualizer
from LSTM.LSTM import LSTM
from EvolutionalStrategy import EvolutionalStrategy
from DataProcessor import DataProcessor

import matplotlib.pyplot as plt

from helpers.useFunctions import rastrigin, styblinski_tang, holder_table, parabola

def denormalize(data, normalized_data):
   mean = sum(data) / len(data)
   std = (sum((x - mean)**2 for x in data) / len(data))**0.5

   return [x * std + mean for x in normalized_data]

def show_data(train_data, control_data, results):
   flattened_train_data = [num for row in train_data for num in row]
   flattened_control_data = [num for row in control_data for num in row]
    
   unique_train_data = sorted(set(flattened_train_data))
   unique_control_data = sorted(set(flattened_control_data))

   x_train = list(range(len(unique_train_data)))
   x_control = list(range(len(unique_train_data), len(unique_train_data) + len(unique_control_data)))
   x_results = [153, 156, 159, 162, 165, 168, 171, 174, 177, 180]

   plt.figure(figsize=(12, 6))

   plt.plot(x_train, unique_train_data, marker='o', color='blue')
   plt.plot(x_control, unique_control_data, marker='o', color='purple')
   plt.plot(x_results, results, marker='o', color='red')

   plt.xlabel("Індекс")
   plt.ylabel("Значення")
   plt.grid(True)
   plt.tight_layout()
   plt.show()

def test_LSTM():
   features_number = 3
   train_length = 20
   control_length = 10
   dataProcessor = DataProcessor(parabola, features_number, train_length, control_length)
   dataProcessor.form_data_table()
   train_sequences, expected_train_results, control_sequences, expected_control_results = dataProcessor.split_data_table()

   hidden_size = 6
   bounds = [-1, 1] 
   dimensions = ( (((hidden_size + 1) * hidden_size) * 4 + hidden_size) + (hidden_size * 4) + 1)
   population_size = 10
   precision = 0.00001
   parents_per_child = 2
   children_per_parents = 6
   tournament_size = 4
   similarity_coefficient = 0.1
   mutation_rate = 0.7
   mutation_strength = 0.2
   
   lstm = LSTM(train_sequences, hidden_size)
   evolutionalStrategy = EvolutionalStrategy(
      population_size, lstm, expected_train_results, bounds, dimensions, 
      parents_per_child, children_per_parents, similarity_coefficient, tournament_size, mutation_rate, mutation_strength
   )

   # params = [-0.5876460912303034, 0.1253614007758455, 0.5860811996835813, 0.3347328179148956, 0.7330952435608024, 0.5332546605768214, 0.2368752261570211, 0.531469593668196, -0.03658486254301224, 0.31488423877908633, 0.7651477438529273, 0.13164748298347867, -0.0004121651468294574, -0.1462840422930198, 0.4088011206304475, -0.2588978122594127, 0.3390626729747124, -0.0069286465157385735, -0.7889405982934714, 0.0819062916732644, -0.31216412734537313, -0.47423856251399316, -0.5168153889403754, 0.3338537772662236, 0.2623250709605005, 0.1737321481071394, -0.5342854509405484, -0.13994544174233442, 0.34065683038329886, -0.1338582242190411, 0.05338941464794075, 0.23848166758298128, 0.15319849664271984, -0.03937634619394394, -0.45447633090168943, -0.13765095830945528, -0.8812576741407244, 0.18364855811749264, 0.1945192031938718, -0.22059541682527634, 0.5736339851153932, 0.10293343132510277, -0.11487976929070762, 0.4451942282157859, 0.032194934176310225, -0.30753176328443826, -0.025360223798210985, -0.6899512014852497, 0.35965387982202407, 0.8506243694607859, -0.5332367266721921, 0.0002671270804083109, -0.8030901815889083, 0.010441615086599715, 0.29974025934522336, -0.039185977719121384, -0.34028449517148274, 0.34456185403128936, 0.3742261054638597, -0.7819759755773991, -0.07582412177063663, -0.2787151011861036, -0.17130438232418704, 0.20036236432372476, -0.3218220325920409, 0.28708668842141466, 0.4182498589523706, 0.08650346660969446, 0.7661174614928926, 0.4781838943509429, 0.24415934744244355, -0.5162239615095405, -0.00373096050778865, 0.7021297249674184, 0.2940861596667056, 0.7095182248388754, -0.15315693976578798, -0.45520881941253033, 0.03932610850454761, 0.18140665688103147, 0.20108358344382, 0.1310176385637884, 0.08144946144842699, -0.255539918600796, 0.22511844298920747, -0.26432586842491174, -0.2904140766666454, 0.1764800057567345, -0.3433422755194088, -0.15837702397670522, 
      # -0.11194985112331851, -0.016265703200342957, -0.7605672082791743, 0.12982480874640273, -0.48608279362257145, 0.01746464624480569, -0.5335566199880926, -0.627220024887182, 0.235710077884375, -0.22653577656919094, 0.1696778325899595, 0.10443283387002415, -0.16920788788793867, -0.5327764258677916, 0.4941731779766613, 0.05508392259537551, 0.5852034862286267, -0.1854901589508704, 0.5666220115615771, 0.04789924963769612, 0.03256846608490495, 0.20579478007944146, -0.37216452719594856, 0.47572325741641797, 0.382707132910074, -0.10472237405424312, -0.31604999942790213, 0.23276197144057115, 0.045770971022089, 0.29663409270556956, -0.06593831560435705, 0.5668685300916999, -0.031513030603882664, -0.2705011360463181, -0.691550167404465, 0.14080572843545539, 0.19507605611563783, 0.43373268171224993, 0.1580681792269592, -0.042358805831376425, -0.14866891585584963, -0.281639250959259, 0.16218141195665672, -0.2867839911998378, -0.32685499773028875, -0.0030122201163204215, 0.14155067950568279, -0.23299002799330665, 0.528912953625043, 0.3895450845000282, 0.10473775384465205, 0.48144842582688474, 0.0311816462506799, -0.3299756832883493, -0.30508180032021237, -0.7433890474356831, -0.08875734804285611, 0.7131081457892496, 0.42769868476735284, 0.04254000508379692, -0.07754374424086533, 0.3066722529363235, -0.15532734055382308, 0.30889702488763493, -0.43139561512325214, -0.7984017344974582, 0.09223654473043238, -0.16869434313664966, 0.062025358262059474, 0.46926776648259205, -0.23147189931607948, 0.40290851034983577, -0.2781980748879129, 0.13314122220735547, -0.4630724758887771, -0.3580260806154228, -0.2593875790503454, -0.1361752255147156, 0.035874479770057935, -0.3302839474727529, 0.2900701975378102, -0.38194741261469967, -0.19810349693113366, 0.08634013650591846, 0.11289141925418036, -0.26826042824235885, 0.09350650328516222, -0.006036044952016456, -0.22515153592614967, 0.05874462077834473, 0.03248994777193709, -0.11060479295336204, 0.1995181747372529, -0.036954541599428736, -0.2359214139702323, -0.18573902814171714, -0.06319365002174376, -0.4926970097626093, 0.011743909997388474, -1.0377018680277503, -0.07712412036839215, -0.44067029990919065, -0.6254387351005203, 0.4074302069120176, 0.6074092943211038, -0.6804649745817867, -0.36826177646985436, -0.4377596481591637, 1.0093048629734425, -0.5886366832162198, -0.4285138665276466, -0.6181778315567594, 0.3300801539590989, -0.07322818414424032, 0.41332877208597524, -0.4506285256250637, 0.09734765617010589, -0.6176313467619767, 0.054481688811849754, 0.5250220739452198, -0.04664056741752001, 0.22639268479175925, 0.11036750646002119, 0.09629720082826684, 0.09891316638387859, 0.300880197562949, 0.4453913824393394, 0.2035978497679683, -0.15517691847189374, 0.668725111596786, -0.6937989812726096, 0.17963913581384183, -0.3601534980178917, 0.41213200056264077, 0.09779828429010112, 0.4217940344403448, 0.019848888529719333, 0.023638440180203432, -0.05501561405036587, -0.7235183473954753, 0.18068798258110497, 0.13404531676884163, 0.015180261291612415, 0.05810495595902429, -0.3579741856486969, -0.2510664525287382, 0.13150336275027968, 0.10422085459432408, 0.3968947403617846, -0.1230780697638161, -0.29930358436545396, -0.2833583539666735, -0.4988997519948076, 0.25266711444756973, -0.12348446924837253, 0.43911534445072387, -0.17897265954256086, 0.07894677838480935, -0.2711801702925082, -0.23411357091167226, 0.2389887007547571, 
      # -0.28139139901776866, 0.8674437330824649, -0.3368076752769934, 0.3200973078255391, -0.47440613891808203, 0.4876919772525589, 0.7370040512718081, -0.09282978224930287, -0.14802502226846773, 0.5091069625169106, 0.35154218914664653, 0.35704502963620594, -0.17636154219626363, 0.3352267156152706, -0.23040326489065005, 0.005203444680739647, -0.48466447764803416, 0.4602477719715129, 0.17902522776979704, 0.23953928545756029, -0.6294853531751506, 0.8047925857278987, 0.032852873300124374, 0.18318394190140044, 0.604317918205976, -0.11345870128577973, 0.2125446846424665, -0.03590938146472627, 0.2797918382903606, 0.359622105758486, 0.3309498997775373, -0.10342799772383052, -0.543255914090016, 0.3550026308747619, -0.4451009541231821, -0.3594551970483562, 0.26723825979699845, 0.8399308138285426, -0.1274449617898371, 0.5849622394200721, -0.3856080804050937, 0.3326703318659314, 0.25699951968024615, -1.0251830204795858, 0.10151937210095657, 0.031332142654082906, -0.3715800328334152, -0.5180462707635688, -0.30970020428010553, -0.42056821057886606, 0.23733596044525665, 0.6056341733089604, -0.10263706479449738, 0.8514422846320293, 0.43305387783584026, 0.37780021779823014, -0.0045456626895458985, -0.3648247345158621, -0.004214428852228946, -0.13724827150253807, 0.3308794465781958, -0.6112459267750239, 0.2894092771943052, -0.4089749601235946, 0.015288347550159453, 0.25171160006491056, -0.23091213688200368, 0.2808895754041769, -0.07823245721828309, 0.5845587196112745, 0.3146865709353421, -0.07574505253792939, -0.3049365548748509, -0.2706129304964459, 0.7868164992984189, 0.07927063632477552, -0.2725596662311763, 0.020267387820818647, -0.3378878019869346, 0.2546372539188343, 0.45766968920850837, -0.0770824285328165, -0.7429601097393359, -0.1401147600421518, -0.37154658646656197, -0.2661333107806256, -0.397831384134384, -0.36144626856773754, 0.42114173542090766, -0.20724838414665325, 0.24904788087999016, 0.5662489859130071, -0.5539718755059149, -0.7738022318345691, -0.37297833673540226, -0.6871591856782854, 0.05250124956040371, 0.369912608247784, -0.4075947320172425, -0.5138980454672331, -0.35346128102496477, -0.3488977384982949, -0.1796668326439519, -0.8671903929889557, 0.01942460571519021, -0.11742495040144035, 0.025380500646557086, 0.009387587629135094, 0.7059369703201526, -0.9881113881102502, -0.22896476053923367, -0.8138519855502486, -0.0812290654239947, 0.9554088274376575, 0.18893866172399326, -0.8735963478266295, -0.5503233968898192, -0.7161639815322671, -0.3860133577171253, 0.22696559324460963, -0.4458822277598446, -0.5008301919943051, 0.230395929933069, 0.708650783427124, 0.3313352487260185, -0.1136542680638255, 0.5518125416399798, -0.3931237965587463, 0.2999842821558325, 0.3373943984993206, 0.09192109362988855, -0.4100588215661294, 0.9047174633344877, -0.007728569732506407, -0.14250351244557585, -0.31195130158403345, 0.3237570337239346, 0.06150400699298046, 0.057527143923492986, 0.05915862480424312, 0.37007788929322905, 0.5341207192465212, 0.18301357331535356, -0.3146580697810514, -0.5050000911267591, -0.21384906775550844, -0.48756621685575086, -0.08213386308980708, 0.34272491545883965, 0.08245918007505097, 0.27750189902557465, 0.31069118616815083, 0.04954114903108153, 0.5602710957432802, -0.1134675038612731]
   params = evolutionalStrategy.optimize(precision)
   lstm.set_params(params)
   print("LSTM Params:", params)
   train_results = lstm.fit()
   control_results = []

   for sequence in control_sequences:
      control_results.append(lstm.compute(sequence))

   denormalized_train_results = dataProcessor.denormalize(train_results)
   denormalized_train_expected_values = dataProcessor.denormalize(expected_train_results)
   denormalized_control_results = dataProcessor.denormalize(control_results)
   denormalized_expected_control_results = dataProcessor.denormalize(expected_control_results)



   dataVisualizer = DataVisualizer(features_number, train_length, control_length)
   dataVisualizer.set_train_results(denormalized_train_results, 'blue')
   dataVisualizer.set_expected_train_results(denormalized_train_expected_values, 'red')
   dataVisualizer.set_control_results(denormalized_control_results, 'lightblue')
   dataVisualizer.set_exprected_control_results(denormalized_expected_control_results, 'pink')

   dataVisualizer.build_plot()

   print("Train_results:")
   for i in range(len(control_results)):
      print("Error:", abs(denormalized_train_expected_values[i] - denormalized_train_results[i]))

   
   # control_results = []

   # for i in range(len(control_sequences)):
   #    result = lstm.compute(control_sequences[i])
   #    control_results.append(result)

def test_evolutional_algorithm():
   fitness_functions = [
      rastrigin,
      styblinski_tang,
      holder_table
   ]

   dimensions = [
      10,
      10,
      2
   ]

   expected_outputs = [
      0, -39.166165 * dimensions[1], -19.2058
   ]

   bounds = [
      [-5.12, 5.12],
      [-5.0, 5.0],
      [-10.0, 10.0]
   ]

   expected_args = [
      [0,0],
      [-2.9035, -2.9035],
      [8.05502, 9.66459]
   ]

   population_size = 1000
   precision = 0.001 
   parents_per_child = 2
   children_per_parents = 7
   tournament_size = 3
   similarity_coefficient = 0.2
   mutation_rate = 0.7
   mutation_strength = 5

   results = []

   evolutionalStrategy = EvolutionalStrategy(
      population_size, 
      fitness_functions[0], 
      expected_outputs[0], 
      bounds[0], 
      dimensions[0], 
      parents_per_child, 
      children_per_parents,
      similarity_coefficient,
      tournament_size,
      mutation_rate, 
      mutation_strength)

   for i in range(len(fitness_functions)):
      evolutionalStrategy.set_fitness_function(fitness_functions[i])
      evolutionalStrategy.set_bounds(bounds[i])
      evolutionalStrategy.set_dimensions(dimensions[i])
      evolutionalStrategy.set_expected_output(expected_outputs[i])
      result = evolutionalStrategy.optimize(precision)
      results.append(result)

   for i in range(len(results)):
      print(fitness_functions[i](results[i]), fitness_functions[i](expected_args[i]))

def main():
   test_LSTM() 
   # test_evolutional_algorithm()

if __name__ == "__main__":
    main()